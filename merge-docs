#!/bin/bash
#
# merge-docs - macOS ç»ˆç«¯ Word æ–‡æ¡£åˆå¹¶å·¥å…·
# ä½¿ç”¨: merge-docs <æ–‡ä»¶å¤¹è·¯å¾„> [è¾“å‡ºæ–‡ä»¶è·¯å¾„]
#

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# è·å–è„šæœ¬æ‰€åœ¨ç›®å½•
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PYTHON_SCRIPT="$SCRIPT_DIR/merge_docs_with_content.py"

# æ˜¾ç¤ºå¸®åŠ©
show_help() {
    cat << EOF
${GREEN}Word æ–‡æ¡£åˆå¹¶å·¥å…·${NC}

ç”¨æ³•:
    merge-docs <è¾“å…¥æ–‡ä»¶å¤¹> [è¾“å‡ºæ–‡ä»¶]

å‚æ•°:
    è¾“å…¥æ–‡ä»¶å¤¹    åŒ…å« .docx æ–‡ä»¶çš„æ–‡ä»¶å¤¹è·¯å¾„
    è¾“å‡ºæ–‡ä»¶      å¯é€‰ï¼Œé»˜è®¤ä¸º merged.docx

ç¤ºä¾‹:
    merge-docs ./my_documents
    merge-docs ./my_documents ./output.docx
    merge-docs /Users/xxx/Downloads/docs ~/Desktop/merged.docx

EOF
}

# æ£€æŸ¥ Python3
check_python() {
    if ! command -v python3 &> /dev/null; then
        echo -e "${RED}âŒ é”™è¯¯: æœªæ‰¾åˆ° Python3${NC}"
        echo "è¯·å…ˆå®‰è£… Python3: https://www.python.org/downloads/"
        exit 1
    fi
}

# æ£€æŸ¥ python-docx ä¾èµ–
check_dependencies() {
    # ä¸´æ—¶ç¦ç”¨ set -eï¼Œé˜²æ­¢ pip å¤±è´¥æ—¶é€€å‡º
    set +e
    
    python3 -c "import docx" 2>/dev/null
    if [ $? -ne 0 ]; then
        echo -e "${YELLOW}âš ï¸  æ­£åœ¨å®‰è£…ä¾èµ– python-docx...${NC}"
        
        # å°è¯•ç”¨æˆ·çº§å®‰è£…
        pip3 install --user python-docx 2>/dev/null
        if [ $? -eq 0 ]; then
            echo -e "${GREEN}âœ… ä¾èµ–å®‰è£…å®Œæˆ${NC}"
            set -e
            return 0
        fi
        
        # å°è¯•å¸¦ --break-system-packages çš„ç”¨æˆ·çº§å®‰è£…
        pip3 install --user --break-system-packages python-docx 2>/dev/null
        if [ $? -eq 0 ]; then
            echo -e "${GREEN}âœ… ä¾èµ–å®‰è£…å®Œæˆ${NC}"
            set -e
            return 0
        fi
        
        # å¦‚æœéƒ½å¤±è´¥äº†
        echo -e "${RED}âŒ è‡ªåŠ¨å®‰è£…å¤±è´¥${NC}"
        echo ""
        echo -e "${YELLOW}è¯·æ‰‹åŠ¨å®‰è£…ä¾èµ–:${NC}"
        echo "  pip3 install --user --break-system-packages python-docx"
        echo ""
        set -e
        exit 1
    fi
    
    # æ¢å¤ set -e
    set -e
}

# ä¸»å‡½æ•°
main() {
    # æ£€æŸ¥å‚æ•°
    if [ $# -eq 0 ] || [ "$1" == "-h" ] || [ "$1" == "--help" ]; then
        show_help
        exit 0
    fi

    INPUT_FOLDER="$1"
    OUTPUT_FILE="${2:-merged.docx}"

    # æ£€æŸ¥è¾“å…¥æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨
    if [ ! -d "$INPUT_FOLDER" ]; then
        echo -e "${RED}âŒ é”™è¯¯: æ–‡ä»¶å¤¹ä¸å­˜åœ¨: $INPUT_FOLDER${NC}"
        exit 1
    fi

    # è½¬æ¢ä¸ºç»å¯¹è·¯å¾„
    INPUT_FOLDER="$(cd "$INPUT_FOLDER" && pwd)"
    
    # å¦‚æœè¾“å‡ºæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œè½¬ä¸ºç»å¯¹è·¯å¾„
    if [[ ! "$OUTPUT_FILE" = /* ]]; then
        OUTPUT_FILE="$PWD/$OUTPUT_FILE"
    fi

    # æ£€æŸ¥ä¾èµ–
    check_python
    check_dependencies

    # æ£€æŸ¥ Python è„šæœ¬æ˜¯å¦å­˜åœ¨
    if [ ! -f "$PYTHON_SCRIPT" ]; then
        echo -e "${RED}âŒ é”™è¯¯: æ‰¾ä¸åˆ°åˆå¹¶è„šæœ¬: $PYTHON_SCRIPT${NC}"
        exit 1
    fi

    echo -e "${BLUE}ğŸš€ å¼€å§‹åˆå¹¶æ–‡æ¡£...${NC}"
    echo -e "${BLUE}ğŸ“ è¾“å…¥æ–‡ä»¶å¤¹: $INPUT_FOLDER${NC}"
    echo -e "${BLUE}ğŸ“„ è¾“å‡ºæ–‡ä»¶: $OUTPUT_FILE${NC}"
    echo ""

    # æ‰§è¡Œåˆå¹¶
    python3 "$PYTHON_SCRIPT" "$INPUT_FOLDER" "$OUTPUT_FILE"

    # æ£€æŸ¥ç»“æœ
    if [ $? -eq 0 ] && [ -f "$OUTPUT_FILE" ]; then
        echo ""
        echo -e "${GREEN}âœ… åˆå¹¶å®Œæˆï¼${NC}"
        echo -e "${GREEN}ğŸ“„ è¾“å‡ºæ–‡ä»¶: $OUTPUT_FILE${NC}"
        
        # å°è¯•æ‰“å¼€æ–‡ä»¶æ‰€åœ¨æ–‡ä»¶å¤¹
        if command -v open &> /dev/null; then
            echo -e "${BLUE}ğŸ“‚ æ­£åœ¨æ‰“å¼€è¾“å‡ºæ–‡ä»¶å¤¹...${NC}"
            open "$(dirname "$OUTPUT_FILE")"
        fi
    else
        echo -e "${RED}âŒ åˆå¹¶å¤±è´¥${NC}"
        exit 1
    fi
}

main "$@"
